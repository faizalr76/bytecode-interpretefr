<html>
  <body>
    <table border=1 width=100% height=100%>
      <tr>
        <td align=center>
          Code
        </td>
        <td align=center>
          Bytecode
          <input type="button" value="Run"  onclick="run_bytecode()" ></input>
          <input type="button" value="Step" onclick="step_bytecode()"></input>
        </td>
        <td align=center>
          Stack
        </td>
      </tr>

      <tr height=100%>
        <td>
          <textarea rows=50 cols=80>
          </textarea>
        </td>
        <td>
          ip: <input id="ip_text"></input><br>
          <textarea id="bytecode_area" rows=50 cols=80>
push "hello world"
print
          </textarea>
        </td>
        <td>
          sp: <input id="sp_text"></input><br>
          <textarea id="stack_area" rows=50 cols=80>
          </textarea>
        </td>
      </tr>
    </table>

    <script>
      var stack = Array(100);
      var g = window;
      var bytecode_area = document.getElementById("bytecode_area");
      var stack_area = document.getElementById("stack_area");
      var ip_text = document.getElementById("ip_text");
      var sp_text = document.getElementById("sp_text");
      var ip = 0;
      var sp = -1;
      var code;

      update_ui();

      function read (s) {
        console.log("read()");
        let lines = s.trim().split("\n");
        let bytecodes = lines.map(function (line) {
          return line.match(/"[^"]*"|\S+/g);
        });
        return bytecodes;
      }

      function interpret (bytecode) {
        if (bytecode[0] === "push") {
          g.stack[++sp] = bytecode[1];
        }
        else if (bytecode[0] === "print") {
          alert(g.stack[g.sp--]);
        }
      }

      function update_ui () {
        g.ip_text.value = g.ip;
        g.sp_text.value = g.sp;
        g.stack_area.value = g.stack.slice(0, g.sp+1).join("\n");
      }

      function run_bytecode () {
        g.ip = 0;
        g.sp = -1;
        g.code = read(g.bytecode_area.value);
        for (let i = 0; i < g.code.length; i++) {
          interpret(g.code[g.ip++]);
        }
        update_ui();
      }

      function step_bytecode () {
        g.code = g.code || read(g.bytecode_area.value);
        g.ip = +g.ip_text.value;

        if (g.ip < g.code.length) {
          interpret(g.code[g.ip++]);
          update_ui();
        }
        else {
          alert("No more code !");
        }
      }
    </script>
  </body>
</html>
